<div class="container-fluid d-flex align-items-center pt-4">
  <div class="col-12 col-sm-12 col-md-12 col-lg-6 p-4 mx-auto shadow-lg border-0 rounded-4">
    <h2 class="text-center mb-4 fw-bold py-3 rounded-4 shadow-sm" style="background-color: #d3d2d2;">
      Dodawanie tygodniowego grafiku
    </h2>
    <form [formGroup]="scheduleForm" class="d-flex flex-column align-items-center">

      <div *ngIf="doctor() as doctor" class="mb-2 w-100">
        <app-doctor-card
          [id]="doctor.id"
          [name]="doctor.name"
          [surname]="doctor.surname"
          [specialization]="doctor.specializations[0].name"
          [profilePicture]="doctor.profilePicture"
          [mode]="'schedule'"
        />
      </div>

      <div class="mb-4 w-100">
        <mat-accordion class="shadow-sm">

          <ng-container *ngFor="let day of weekDays; let i = index">
            <mat-expansion-panel
              class="mb-3 border rounded-3 overflow-hidden"
              [expanded]="step() === i"
              (opened)="setStep(i)"
              hideToggle
            >
              <mat-expansion-panel-header class="bg-light">
                <mat-panel-title class="fw-semibold text-dark">{{ day.label }}</mat-panel-title>
                <mat-panel-description *ngIf="isDaySelected(day.key)" class="text-success fw-medium">
                  {{ getDayHourFrom(day.key) | date: 'HH:mm':'':'pl' }} -
                  {{ getDayHourTo(day.key) | date: 'HH:mm':'':'pl' }}
                </mat-panel-description>
              </mat-expansion-panel-header>

              <div class="row g-3 mt-2 p-3 bg-white">

                <div class="col-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Od</mat-label>
                    <input
                      matInput
                      [ngModel]="getDayHourFrom(day.key)"
                      (ngModelChange)="onTimeFromChange(day.key, $event)"
                      [ngModelOptions]="{standalone: true}"
                      [matTimepicker]="timePickerFrom"
                      [matTimepickerMin]="environmentVariables.startTime"
                      [matTimepickerMax]="environmentVariables.finishTime"
                    />
                    <mat-timepicker-toggle matIconSuffix [for]="timePickerFrom"/>
                    <mat-timepicker #timePickerFrom/>
                  </mat-form-field>
                </div>

                <div class="col-6">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Do</mat-label>
                    <input
                      matInput
                      [ngModel]="getDayHourTo(day.key)"
                      (ngModelChange)="onTimeToChange(day.key, $event)"
                      [matTimepicker]="timePickerTo"
                      [ngModelOptions]="{standalone: true}"
                      [matTimepickerMin]="environmentVariables.startTime"
                      [matTimepickerMax]="environmentVariables.finishTime"
                    />
                    <mat-timepicker-toggle matIconSuffix [for]="timePickerTo"/>
                    <mat-timepicker #timePickerTo/>
                    @if (controls.startedAt.invalid) {
                      <mat-error>{{ getErrorMessage(controls.startedAt) }}</mat-error>
                    }
                  </mat-form-field>
                </div>

                <div class="col-12">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Usługi</mat-label>
                    <mat-select
                      multiple
                      [value]="getDayServices(day.key)"
                      (selectionChange)="onServicesChange(day.key, $event.value)"
                    >
                      <mat-optgroup *ngFor="let group of specializations" [label]="group.name">
                        <mat-option
                          *ngFor="let service of group.services"
                          [value]="service.id"
                        >
                          {{ service.name }}
                        </mat-option>
                      </mat-optgroup>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>

              <mat-action-row class="bg-light border-top p-3">
                <div class="d-flex justify-content-between w-100 gap-2">
                  <button
                    mat-button
                    type="button"
                    *ngIf="i > 0"
                    (click)="prevStep()"
                    class="btn btn-purple px-4"
                  >
                    Powrót
                  </button>
                  <div class="ms-auto d-flex gap-2">
                    <button
                      mat-button
                      type="button"
                      *ngIf="i < weekDays.length - 1"
                      (click)="nextStep()"
                      class="btn btn-green px-4"
                    >
                      Dalej
                    </button>
                    <button
                      mat-button
                      type="button"
                      *ngIf="i === weekDays.length - 1"
                      (click)="nextStep()"
                      class="btn btn-green px-4"
                    >
                      Zamknij
                    </button>
                  </div>
                </div>
              </mat-action-row>

            </mat-expansion-panel>
          </ng-container>

        </mat-accordion>

      </div>
      <div class="d-flex flex-row gap-4 justify-content-center mb-4 w-100">
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Data rozpoczęcia</mat-label>
          <input matInput [matDatepicker]="pickerStart" [formControl]="controls.startedAt"/>
          <mat-datepicker-toggle matIconSuffix [for]="pickerStart"></mat-datepicker-toggle>
          <mat-datepicker #pickerStart></mat-datepicker>
          @if (controls.startedAt.invalid) {
            <mat-error>{{ getErrorMessage(controls.startedAt) }}</mat-error>
          }
        </mat-form-field>
        <mat-form-field appearance="outline" class="w-100">
          <mat-label>Data zakończenia</mat-label>
          <input matInput [matDatepicker]="pickerEnd" [formControl]="controls.finishedAt"/>
          <mat-datepicker-toggle matIconSuffix [for]="pickerEnd"></mat-datepicker-toggle>
          <mat-datepicker #pickerEnd></mat-datepicker>
          @if (controls.finishedAt.invalid) {
            <mat-error>{{ getErrorMessage(controls.finishedAt) }}</mat-error>
          }
        </mat-form-field>
      </div>

      <app-alert class="mt-3 w-75" *ngIf="errorMessage()" [text]="errorMessage()"></app-alert>

      <div class="row w-100 gap-2">
        <div class="col-sm text-center">
          <button mat-flat-button type="button" class="btn btn-purple w-100" (click)="goBack()">Powrót</button>
        </div>
        <div class="col-sm text-center">
          <button mat-flat-button type="button" class="btn btn-green w-100" (click)="createSchedule()"
                  [disabled]="!isFormValid">Utwórz grafik
          </button>
        </div>
      </div>
    </form>
  </div>
</div>
