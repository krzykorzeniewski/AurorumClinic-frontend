<div class="container-fluid d-flex flex-column justify-content-center align-items-center pt-3">
  <h2 class="text-center mb-4">Mój profil</h2>
  <mat-card class="profile-card rounded-2" appearance="outlined">
    <mat-card-content *ngIf="additionalInformationProfileForm && userResponse" class="px-3 px-md-5">
        <mat-accordion>
            <mat-expansion-panel class="disabled mb-2 shadow-none border rounded-2" hideToggle>
              <mat-expansion-panel-header>
                <mat-panel-title> Imię i nazwisko </mat-panel-title>
                <mat-panel-description> {{userResponse.name}}  {{userResponse.surname}} </mat-panel-description>
              </mat-expansion-panel-header>
            </mat-expansion-panel>

          <form id="email" [formGroup]="emailProfileForm" (ngSubmit)="onUpdateEmail()">
            <mat-expansion-panel class="mb-2 shadow-none border rounded-2">
              <mat-expansion-panel-header>
                <mat-panel-title> Email </mat-panel-title>
                <mat-panel-description class="justify-content-between align-content-center">
                  {{userResponse.email}}
                  <mat-icon *ngIf="userResponse.emailVerified" style="color: green;">
                    verified
                  </mat-icon>
                </mat-panel-description>
              </mat-expansion-panel-header>
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Podaj nowy adres email</mat-label>
                <input
                  id="new-email-patient-aurorum"
                  matInput
                  [formControl]="emailControl.email" />
                @if (emailControl.email.invalid) {
                  <mat-error>{{ getErrorMessage(emailControl.email) }}</mat-error>
                }
              </mat-form-field>
              <div class="d-flex justify-content-between mt-4">
                <button form="email" mat-flat-button class="btn text-white border-0" style="background-color: var(--primary-purple)" type="submit" [disabled]="userResponse.email === emailControl.email.value || emailProfileForm.invalid">
                  Zaktualizuj
                </button>
              </div>
            </mat-expansion-panel>
          </form>

            <mat-expansion-panel class="disabled mb-2 shadow-none border rounded-2" hideToggle>
              <mat-expansion-panel-header>
                <mat-panel-title> PESEL </mat-panel-title>
                <mat-panel-description>
                  <span *ngIf="userResponse.pesel">{{userResponse.pesel}}</span>
                  <span *ngIf="!userResponse.pesel" class="badge bg-secondary">BRAK</span>
                </mat-panel-description>
              </mat-expansion-panel-header>
            </mat-expansion-panel>

            <mat-expansion-panel class="disabled mb-2 shadow-none border rounded-2" hideToggle>
              <mat-expansion-panel-header>
                <mat-panel-title> Data urodzenia </mat-panel-title>
                <mat-panel-description> {{userResponse.birthDate | date:'dd.MM.yyyy':'':'pl'}} </mat-panel-description>
              </mat-expansion-panel-header>
            </mat-expansion-panel>

          <form id="phone-number" [formGroup]="phoneProfileForm" (ngSubmit)="onUpdatePhone()">
          <form id="phone-number-verify" [formGroup]="phoneProfileForm" (ngSubmit)="onVerifyPhone()">
            <mat-expansion-panel class="mb-2 shadow-none border rounded-2">
              <mat-expansion-panel-header>
                <mat-panel-title> Numer telefonu </mat-panel-title>
                <mat-panel-description class="justify-content-between align-content-center">
                  {{userResponse.phoneNumber}}
                  <mat-icon *ngIf="userResponse.phoneNumberVerified" style="color: green;">
                    verified
                  </mat-icon>
                </mat-panel-description>
              </mat-expansion-panel-header>
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Podaj nowy numer telefonu</mat-label>
                <input
                  id="new-phone-number-patient-aurorum"
                  matInput
                  [formControl]="phoneControl.phoneNumber" />
                @if (phoneControl.phoneNumber.invalid) {
                  <mat-error>{{ getErrorMessage(phoneControl.phoneNumber) }}</mat-error>
                }
              </mat-form-field>
              <div class="d-flex justify-content-between mt-4">
                <button *ngIf="!userResponse.phoneNumberVerified" form="phone-number-verify" mat-flat-button class="btn text-white border-0" style="background-color: var(--primary-purple)" type="submit" [disabled]="userResponse.phoneNumber !== phoneControl.phoneNumber.value ||  phoneProfileForm.invalid">
                  Zweryfikuj
                </button>
                <button form="phone-number" mat-flat-button class="btn text-white border-0" style="background-color: var(--primary-purple)" type="submit" [disabled]="userResponse.phoneNumber === phoneControl.phoneNumber.value || phoneProfileForm.invalid">
                  Zaktualizuj
                </button>
              </div>
            </mat-expansion-panel>
            </form>
          </form>

            <mat-expansion-panel class="mb-2 shadow-none border rounded-">
              <mat-expansion-panel-header>
                <mat-panel-title> Weryfikacja dwuetapowa </mat-panel-title>
                <mat-panel-description>
                  <span *ngIf="userResponse.twoFactorAuth" class="badge bg-success">AKTYWNE</span>
                  <span *ngIf="!userResponse.twoFactorAuth" class="badge bg-warning">NIEAKTYWNE</span>
                </mat-panel-description>
              </mat-expansion-panel-header>
              <p *ngIf="userResponse.twoFactorAuth">Kliknij poniżej, aby usunąć weryfikację dwuetapową.<br> UWAGA! To działanie jest niezalecane. Chroni to konto przed nieautoryzowanym dostępem!</p>
              <p *ngIf="!userResponse.twoFactorAuth">Kliknij poniżej, aby założyć weryfikację dwuetapową.<br>Dzięki weryfikacji dwuetapowej twoje konto posiada dodatkową warstwę bezpieczeństwa przed nieautoryzowanym dostępem.</p>
              <button *ngIf="userResponse.twoFactorAuth" mat-flat-button class="btn-danger-custom text-white" (click)="onTwoFactorDelete()">Usuń weryfikację dwuetapową</button>
              <button *ngIf="!userResponse.twoFactorAuth" mat-flat-button class="text-white" style="background-color: var(--primary-purple);" (click)="onTwoFactorSetup()">Załóż weryfikację dwuetapową</button>
            </mat-expansion-panel>

          <mat-expansion-panel class="mb-2 shadow-none border rounded-2">
            <mat-expansion-panel-header>
              <mat-panel-title> Hasło </mat-panel-title>
              <mat-panel-description>
                Zmień swoje hasło
              </mat-panel-description>
            </mat-expansion-panel-header>
            <p>Kliknij poniżej, aby zmienić swoje hasło.</p>
            <button mat-flat-button class="btn text-white" style="background-color: var(--primary-purple);" (click)="onPasswordChange()">Zmień hasło</button>
          </mat-expansion-panel>

          <form *ngIf="isPatient$ | async" id="additionalInfo" [formGroup]="additionalInformationProfileForm" (ngSubmit)="onUpdateAdditional()">
            <mat-expansion-panel class="mb-2 shadow-none border rounded-2">
              <mat-expansion-panel-header>
                <mat-panel-title> Dodatkowe </mat-panel-title>
                <mat-panel-description> Newsletter i preferencje komunikacyjne </mat-panel-description>
              </mat-expansion-panel-header>
              <div class="d-flex flex-column gap-3 mt-3">
                <mat-checkbox [formControl]="additionalInfoControls.newsletter">
                  Wyrażam chęć uczestniczenia w newsletterze
                </mat-checkbox>
                <mat-form-field appearance="outline" class="w-50">
                  <mat-label> Preferencje komunikacyjne </mat-label>
                  <mat-select [formControl]="additionalInfoControls.communicationPreferences">
                    <mat-option [value]="communicationPreferences.EMAIL">Email</mat-option>
                    <mat-option *ngIf="userResponse.phoneNumberVerified" [value]="communicationPreferences.PHONE_NUMBER">Telefon</mat-option>
                  </mat-select>
                </mat-form-field>
                <div class="d-flex justify-content-between mt-4">
                  <button
                    form="additionalInfo"
                    mat-flat-button
                    class="btn text-white border-0"
                    style="background-color: var(--primary-purple)"
                    type="submit"
                    [disabled]="isAdditionalInfoDisabled">
                    Zaktualizuj
                  </button>
                </div>
              </div>
            </mat-expansion-panel>
          </form>

            <mat-expansion-panel *ngIf="isPatient$ | async" class="mb-2 shadow-none border rounded-2">
              <mat-expansion-panel-header>
                <mat-panel-title> Usunięcie konta </mat-panel-title>
                <mat-panel-description> Usuń swoje dane </mat-panel-description>
              </mat-expansion-panel-header>
              <button mat-flat-button class="btn btn-danger-custom" (click)="openDeleteDialog()">Usuń konto</button>
            </mat-expansion-panel>
      </mat-accordion>
    </mat-card-content>
    <app-alert class="mt-3 w-75 m-auto" *ngIf="infoMessage()" [text]="infoMessage()" [variant]="variant()"></app-alert>
  </mat-card>
</div>
