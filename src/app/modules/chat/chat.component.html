<div class="container py-3" [ngStyle]="{'height': isSmallScreen ? 'auto' : 'calc(100vh - 300px)'}">
  <div>
    <h3 class="text-center pt-3">Wiadomości</h3>
  </div>
  <div *ngIf="chats().length === 0" class="d-flex align-items-center justify-content-center"
       [ngStyle]="{'height': isSmallScreen ? '60vh' : 'calc(100vh - 400px)'}">
    <div class="text-center text-muted p-4">
      <mat-icon style="font-size: 64px; width: 64px; height: 64px;" class="mb-3">chat_bubble_outline</mat-icon>
      <h5>Brak konwersacji</h5>
      <p class="small mb-0">Nie masz jeszcze żadnych wiadomości</p>
    </div>
  </div>

  <div *ngIf="chats().length > 0" class="row" [class.h-100]="!isSmallScreen">

    <div class="card col-12 col-md-4 col-lg-3 p-2"
         [class.d-none]="selectedChat() && isSmallScreen"
         [class.h-100]="!isSmallScreen"
         [ngStyle]="{'max-height': isSmallScreen ? '70vh' : 'none', 'overflow-y': isSmallScreen ? 'auto' : 'visible'}">

      <div *ngIf="isSmallScreen && !selectedChat()" class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Konwersacje</h5>
      </div>

      <div *ngFor="let chat of chats()" class="card p-2 overflow-hidden mb-2 chat-group">
        <button
          type="button"
          class="list-group-item list-group-item-action d-flex align-items-center justify-content-between gap-2"
          (click)="selectChat(chat)"
          [class.active]="selectedChat()?.id === chat.id">

          <img
            *ngIf="chat.profilePicture"
            [src]="chat.profilePicture"
            class="rounded-circle"
            width="40"
            height="40"
            alt="avatar">

          <span class="flex-grow-1">{{ chat.name }} {{ chat.surname }}</span>

          <span
            *ngIf="isChatUnread(chat.id)"
            class="rounded-circle bg-danger d-inline-block pulse-dot"
            style="width: 12px; height: 12px; min-width: 12px;"
            title="Nowa wiadomość">
          </span>
        </button>
      </div>
    </div>

    <div class="col-12 col-md-8 col-lg-9"
         [class.h-100]="!isSmallScreen"
         [class.d-none]="!selectedChat() && isSmallScreen"
         [class.d-flex]="!isSmallScreen || selectedChat()"
         [class.flex-column]="!isSmallScreen || selectedChat()">

      <div *ngIf="!selectedChat() && !isSmallScreen" class="card h-100 d-flex align-items-center justify-content-center">
        <div class="text-center text-muted p-4">
          <h5>Wybierz konwersację</h5>
          <p>Wybierz czat z listy, aby rozpocząć rozmowę</p>
        </div>
      </div>

      <div *ngIf="selectedChat() as chat" class="d-flex flex-column" [class.h-100]="!isSmallScreen">

        <div class="card py-2 px-3 mb-2 text-start d-flex flex-row align-items-center gap-2">
          <button
            *ngIf="isSmallScreen"
            type="button"
            class="btn btn-sm btn-outline-secondary d-md-none"
            (click)="deselectChat()">
            ← Powrót
          </button>
          <span>{{ chat.name }} {{ chat.surname }}</span>
        </div>

        <div
          #messagesContainer
          class="card overflow-auto p-3 mb-2 bg-light"
          [class.flex-grow-1]="!isSmallScreen"
          [ngStyle]="{'height': isSmallScreen ? '60vh' : 'auto', 'max-height': isSmallScreen ? '60vh' : 'none'}"
          (scroll)="onScroll($event)">

          <div *ngIf="isLoadingMessages()" class="text-center mb-3">
            <div class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden">Ładowanie...</span>
            </div>
          </div>

          <div *ngIf="!hasMoreMessages() && messages().length > 0" class="text-center text-muted small mb-3">
            To początek konwersacji
          </div>

          <div *ngFor="let msg of messages()" class="mb-3 d-flex"
               [class.justify-content-end]="msg.authorId !== chat.id">

            <div
              class="p-2 rounded mw-75"
              [style.background-color]="msg.authorId !== chat.id ? 'var(--primary-purple)' : 'white'"
              [class.text-white]="msg.authorId !== chat.id"
              [class.bg-white]="msg.authorId === chat.id"
              style="max-width: 75%; word-wrap: break-word;">

              <div class="small">{{ msg.text }}</div>
              <div class="text-end small"
                   [class.text-white]="msg.authorId !== chat.id"
                   [class.text-muted]="msg.authorId === chat.id">
                {{ msg.sentAt | date:'HH:mm' }}
              </div>
            </div>
          </div>
        </div>

        <div class="p-2">
          <form class="d-flex gap-2" (ngSubmit)="sendMessage()">
            <input
              autocomplete="off"
              type="text"
              class="form-control"
              placeholder="Treść wiadomości"
              [(ngModel)]="message"
              name="message"
            />
            <button class="btn btn-purple" type="submit">
              Wyślij
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
